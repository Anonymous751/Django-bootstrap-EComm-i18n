<!-- üõí Cart Modal -->
 {% load i18n %}
<div
  class="modal fade"
  id="cartModal"
  tabindex="-1"
  aria-labelledby="cartModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div
      class="modal-content cart-modal-glass border-0 shadow-lg rounded-4 overflow-hidden"
    >
      <!-- Header -->
      <div class="modal-header bg-gradient-primary  border-0">
        <h5 class="modal-title fw-bold" id="cartModalLabel">
          üõí {% trans "Your Cart" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white shadow-none"
          data-bs-dismiss="modal"
          aria-label="{% trans 'Close' %}"
        ></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div id="cart-items-container">
          {% if cart_items %}
            {% for item in cart_items %}
              <div
                class="d-flex align-items-center mb-3 border-bottom pb-2 cart-item"
                data-cart-item-id="{{ item.pk }}"
              >
                <img
                  src="{{ item.product.images.url }}"
                  class="me-3 rounded-3 shadow-sm cart-item-img"
                  width="60"
                  alt="{{ item.product.name }}"
                />
                <div class="flex-grow-1">
                  <h6 class="mb-1 fw-semibold">{{ item.product.name }}</h6>
                  <div class="d-flex align-items-center">
                    <button
                      class="btn btn-sm btn-outline-secondary me-2 rounded-circle decrease-btn"
                    >
                      ‚àí
                    </button>
                    <span class="quantity fw-semibold">{{ item.quantity }}</span>
                    <button
                      class="btn btn-sm btn-outline-secondary ms-2 rounded-circle increase-btn"
                    >
                      +
                    </button>
                    <small class="ms-3">
                      {% trans "Price" %}: ‚Çπ<span class="item-total fw-semibold">{{ item.total_price }}</span>
                    </small>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-center ">{% trans "Your cart is empty!" %}</p>
          {% endif %}
        </div>

        <!-- ‚úÖ Total -->
        <div class="d-flex justify-content-between mt-3 border-top pt-3">
          <strong class="fs-6">{% trans "Total" %}:</strong>
          <span id="cart-total" class="fw-bold text-success fs-6">
            ‚Çπ{{ cart_total }}
          </span>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0 d-flex justify-content-between">
        <button
          type="button"
          class="btn btn-outline-dark rounded-pill px-4 py-2 fw-semibold"
          data-bs-dismiss="modal"
        >
          {% trans "Continue Shopping" %}
        </button>
        <a
          href="{% url 'checkout' %}"
          class="btn btn-gradient px-4 py-2 rounded-pill fw-semibold"
          id="checkout-btn"
        >
          {% trans "Checkout" %} <i class="bi bi-arrow-right ms-1"></i>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Toast container -->
<div
  id="toast-container-top"
  class="position-fixed top-0 start-50 translate-middle-x mt-3"
  style="z-index: 1080"
></div>

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cartCountBadge = document.querySelector(".navbar .badge");
    const cartItemsContainer = document.getElementById("cart-items-container");
    const cartTotalElem = document.getElementById("cart-total");

    function updateCartModal(cart_items, cart_total, cart_count) {
      cartCountBadge.textContent = cart_count;
      cartTotalElem.textContent = `‚Çπ${cart_total.toFixed(2)}`;
      cartItemsContainer.innerHTML = "";

      if (cart_items.length > 0) {
        cart_items.forEach((item) => {
          cartItemsContainer.insertAdjacentHTML(
            "beforeend",
            `
          <div class="d-flex align-items-center mb-3 border-bottom pb-2 cart-item" data-cart-item-id="${item.id}">
            <img src="${item.image}" class="me-3 rounded-3 shadow-sm cart-item-img" width="60" alt="${item.name}">
            <div class="flex-grow-1">
              <h6 class="mb-1 fw-semibold">${item.name}</h6>
              <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-outline-secondary me-2 rounded-circle quantity-btn">‚àí</button>
                <span class="quantity fw-semibold">${item.quantity}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2 rounded-circle quantity-btn">+</button>
                <small class="text-muted ms-3">Price: ‚Çπ<span class="item-total fw-semibold">${item.total_price}</span></small>
              </div>
            </div>
          </div>
        `
          );
        });
        attachQuantityButtons();
      } else {
        cartItemsContainer.innerHTML =
          '<p class="text-center text-muted">Your cart is empty!</p>';
      }
    }

    function attachQuantityButtons() {
      document
        .querySelectorAll(".increase-btn, .decrease-btn")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const cartItemDiv = btn.closest("[data-cart-item-id]");
            const itemId = cartItemDiv.dataset.cartItemId;
            const action = btn.classList.contains("increase-btn")
              ? "increase"
              : "decrease";

            fetch("{% url 'update_cart_item' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
              },
              body: `item_id=${itemId}&action=${action}`,
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success)
                  updateCartModal(
                    data.cart_items,
                    data.cart_total,
                    data.cart_count
                  );
              });
          });
        });
    }

    document.querySelectorAll(".add-to-cart-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const productId = btn.dataset.productId;

        fetch(`/add-to-cart/?product_id=${productId}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              updateCartModal(
                data.cart_items,
                data.cart_total,
                data.cart_count
              );
              showToast("‚úÖ Item added to cart!", "success");
            } else {
              showToast("‚ö†Ô∏è Please login to add items.", "danger");
            }
          });
      });
    });

    attachQuantityButtons();

    const checkoutBtn = document.getElementById("checkout-btn");
    checkoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const cartModalEl = document.getElementById("cartModal");
      const modalInstance = bootstrap.Modal.getOrCreateInstance(cartModalEl);
      modalInstance.hide();

      setTimeout(() => {
        window.location.href = checkoutBtn.href;
      }, 200);
    });
  });
</script>

<style>
/* =================== LIGHT MODE VARIABLES =================== */
:root {
  /* Gradient header */
  --bg-gradient-primary: linear-gradient(135deg, #0a415aff, #0a415aff);

  /* Glass modal */
  --cart-modal-bg: rgba(255, 255, 255, 0.85);

  /* Cart item image border */
  --cart-item-border: rgba(78, 84, 200, 0.15);

  /* Checkout button gradient */
  --btn-gradient-bg: linear-gradient(135deg, #00b09b, #96c93d);
  --btn-gradient-hover-bg: linear-gradient(135deg, #00a88d, #8cc63f);
  --btn-gradient-color: #ffffff;
  --btn-gradient-hover-shadow: 0 4px 12px rgba(0, 176, 155, 0.3);
}

/* =================== DARK MODE VARIABLES =================== */
[data-theme="dark"] {
  --bg-gradient-primary: linear-gradient(135deg, #07425a, #0a3a4f);
  --cart-modal-bg: rgba(10, 15, 25, 0.85);
  --cart-item-border: rgba(200, 200, 255, 0.15);

  --btn-gradient-bg: linear-gradient(135deg, #00775f, #005f3f);
  --btn-gradient-hover-bg: linear-gradient(135deg, #005f3f, #004f33);
  --btn-gradient-color: #ffffff;
  --btn-gradient-hover-shadow: 0 4px 12px rgba(0, 128, 80, 0.4);
}

/* =================== APPLY VARIABLES =================== */

/* üåà Beautiful gradient header */
.bg-gradient-primary {
  background: var(--bg-gradient-primary);
  transition: background 0.3s ease;
}

/* üåü Glassmorphism modal */
.cart-modal-glass {
  backdrop-filter: blur(16px);
  background: var(--cart-modal-bg);
  transition: background 0.3s ease;
}

/* üñºÔ∏è Cart item image */
.cart-item-img {
  border: 2px solid var(--cart-item-border);
  transition: border-color 0.3s ease;
}

/* ‚ûï‚ûñ quantity buttons */
.quantity-btn {
  width: 28px;
  height: 28px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ‚ú® Checkout gradient button */
.btn-gradient {
  background: var(--btn-gradient-bg);
  color: var(--btn-gradient-color);
  transition: all 0.3s ease;
  border: none;
}

.btn-gradient:hover {
  transform: translateY(-2px);
  background: var(--btn-gradient-hover-bg);
  box-shadow: var(--btn-gradient-hover-shadow);
  color: var(--btn-gradient-color);
}

</style>
{% endblock %}
